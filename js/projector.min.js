THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.v3=new THREE.RenderableVertex();this.normalModel=new THREE.Vector3();this.vertexNormalsModel=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];this.vertexNormalsLength=0;this.color=new THREE.Color();this.material=null;this.uvs=[new THREE.Vector2(),new THREE.Vector2(),new THREE.Vector2()];this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector4();this.visible=true};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.vertexColors=[new THREE.Color(),new THREE.Color()];this.material=null;this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2();this.material=null};THREE.Projector=function(){var Q,C,J=[],n=0,v,c,f=[],b=0,l,A,F=[],x=0,i,M,O=[],t=0,y,q,e=[],P=0,H={objects:[],lights:[],elements:[]},I=new THREE.Vector3(),G=new THREE.Vector4(),r=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),R=new THREE.Box3(),L=new Array(3),K=new Array(4),a=new THREE.Matrix4(),g=new THREE.Matrix4(),z,B=new THREE.Matrix4(),o=new THREE.Matrix3(),N=new THREE.Frustum(),s=new THREE.Vector4(),h=new THREE.Vector4();this.projectVector=function(S,T){console.warn("THREE.Projector: .projectVector() is now vector.project().");S.project(T)};this.unprojectVector=function(S,T){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");S.unproject(T)};this.pickingRay=function(S,T){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var d=function(){var ae=[];var aa=[];var Z=null;var ac=null;var Y=new THREE.Matrix3();var W=function(ag){Z=ag;ac=Z.material;Y.getNormalMatrix(Z.matrixWorld);ae.length=0;aa.length=0};var ab=function(ai){var ag=ai.position;var aj=ai.positionWorld;var ah=ai.positionScreen;aj.copy(ag).applyMatrix4(z);ah.copy(aj).applyMatrix4(g);var ak=1/ah.w;ah.x*=ak;ah.y*=ak;ah.z*=ak;ai.visible=ah.x>=-1&&ah.x<=1&&ah.y>=-1&&ah.y<=1&&ah.z>=-1&&ah.z<=1};var T=function(ag,ai,ah){v=u();v.position.set(ag,ai,ah);ab(v)};var V=function(ag,ai,ah){ae.push(ag,ai,ah)};var U=function(ag,ah){aa.push(ag,ah)};var X=function(ai,ah,ag){if(ai.visible===true||ah.visible===true||ag.visible===true){return true}L[0]=ai.positionScreen;L[1]=ah.positionScreen;L[2]=ag.positionScreen;return r.isIntersectionBox(R.setFromPoints(L))};var ad=function(ai,ah,ag){return((ag.positionScreen.x-ai.positionScreen.x)*(ah.positionScreen.y-ai.positionScreen.y)-(ag.positionScreen.y-ai.positionScreen.y)*(ah.positionScreen.x-ai.positionScreen.x))<0};var af=function(ah,ag){var aj=f[ah];var ai=f[ag];i=E();i.id=Z.id;i.v1.copy(aj);i.v2.copy(ai);i.z=(aj.positionScreen.z+ai.positionScreen.z)/2;i.material=Z.material;H.elements.push(i)};var S=function(ap,an,al){var aq=f[ap];var ao=f[an];var am=f[al];if(X(aq,ao,am)===false){return}if(ac.side===THREE.DoubleSide||ad(aq,ao,am)===true){l=k();l.id=Z.id;l.v1.copy(aq);l.v2.copy(ao);l.v3.copy(am);l.z=(aq.positionScreen.z+ao.positionScreen.z+am.positionScreen.z)/3;for(var aj=0;aj<3;aj++){var ai=arguments[aj]*3;var ak=l.vertexNormalsModel[aj];ak.set(ae[ai],ae[ai+1],ae[ai+2]);ak.applyMatrix3(Y).normalize();var ag=arguments[aj]*2;var ah=l.uvs[aj];ah.set(aa[ag],aa[ag+1])}l.vertexNormalsLength=3;l.material=Z.material;H.elements.push(l)}};return{setObject:W,projectVertex:ab,checkTriangleVisibility:X,checkBackfaceCulling:ad,pushVertex:T,pushNormal:V,pushUv:U,pushLine:af,pushTriangle:S}};var D=new d();this.projectScene=function(ao,ag,aq,W){A=0;M=0;q=0;H.elements.length=0;if(ao.autoUpdate===true){ao.updateMatrixWorld()}if(ag.parent===undefined){ag.updateMatrixWorld()}a.copy(ag.matrixWorldInverse.getInverse(ag.matrixWorld));g.multiplyMatrices(ag.projectionMatrix,a);N.setFromMatrix(g);C=0;H.objects.length=0;H.lights.length=0;ao.traverseVisible(function(aR){if(aR instanceof THREE.Light){H.lights.push(aR)}else{if(aR instanceof THREE.Mesh||aR instanceof THREE.Line||aR instanceof THREE.Sprite){if(aR.material.visible===false){return}if(aR.frustumCulled===false||N.intersectsObject(aR)===true){Q=m();Q.id=aR.id;Q.object=aR;I.setFromMatrixPosition(aR.matrixWorld);I.applyProjection(g);Q.z=I.z;H.objects.push(Q)}}}});if(aq===true){H.objects.sort(p)}for(var aE=0,au=H.objects.length;aE<au;aE++){var aA=H.objects[aE].object;var ac=aA.geometry;D.setObject(aA);z=aA.matrixWorld;c=0;if(aA instanceof THREE.Mesh){if(ac instanceof THREE.BufferGeometry){var ay=ac.attributes;var al=ac.offsets;if(ay.position===undefined){continue}var aa=ay.position.array;for(var aJ=0,aH=aa.length;aJ<aH;aJ+=3){D.pushVertex(aa[aJ],aa[aJ+1],aa[aJ+2])}if(ay.normal!==undefined){var aj=ay.normal.array;for(var aJ=0,aH=aj.length;aJ<aH;aJ+=3){D.pushNormal(aj[aJ],aj[aJ+1],aj[aJ+2])}}if(ay.uv!==undefined){var ax=ay.uv.array;for(var aJ=0,aH=ax.length;aJ<aH;aJ+=2){D.pushUv(ax[aJ],ax[aJ+1])}}if(ay.index!==undefined){var V=ay.index.array;if(al.length>0){for(var aE=0;aE<al.length;aE++){var az=al[aE];var ar=az.index;for(var aJ=az.start,aH=az.start+az.count;aJ<aH;aJ+=3){D.pushTriangle(V[aJ]+ar,V[aJ+1]+ar,V[aJ+2]+ar)}}}else{for(var aJ=0,aH=V.length;aJ<aH;aJ+=3){D.pushTriangle(V[aJ],V[aJ+1],V[aJ+2])}}}else{for(var aJ=0,aH=aa.length/3;aJ<aH;aJ+=3){D.pushTriangle(aJ,aJ+1,aJ+2)}}}else{if(ac instanceof THREE.Geometry){var U=ac.vertices;var ab=ac.faces;var aw=ac.faceVertexUvs[0];o.getNormalMatrix(z);var aI=aA.material;var Y=aI instanceof THREE.MeshFaceMaterial;var ak=Y===true?aA.material:null;for(var aB=0,af=U.length;aB<af;aB++){var ai=U[aB];I.copy(ai);if(aI.morphTargets===true){var ad=ac.morphTargets;var aG=aA.morphTargetInfluences;for(var aD=0,T=ad.length;aD<T;aD++){var av=aG[aD];if(av===0){continue}var S=ad[aD];var an=S.vertices[aB];I.x+=(an.x-ai.x)*av;I.y+=(an.y-ai.y)*av;I.z+=(an.z-ai.z)*av}}D.pushVertex(I.x,I.y,I.z)}for(var aK=0,ap=ab.length;aK<ap;aK++){var Z=ab[aK];var aI=Y===true?ak.materials[Z.materialIndex]:aA.material;if(aI===undefined){continue}var ae=aI.side;var aQ=f[Z.a];var aO=f[Z.b];var aM=f[Z.c];if(D.checkTriangleVisibility(aQ,aO,aM)===false){continue}var am=D.checkBackfaceCulling(aQ,aO,aM);if(ae!==THREE.DoubleSide){if(ae===THREE.FrontSide&&am===false){continue}if(ae===THREE.BackSide&&am===true){continue}}l=k();l.id=aA.id;l.v1.copy(aQ);l.v2.copy(aO);l.v3.copy(aM);l.normalModel.copy(Z.normal);if(am===false&&(ae===THREE.BackSide||ae===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(o).normalize();var X=Z.vertexNormals;for(var aF=0,aN=Math.min(X.length,3);aF<aN;aF++){var aP=l.vertexNormalsModel[aF];aP.copy(X[aF]);if(am===false&&(ae===THREE.BackSide||ae===THREE.DoubleSide)){aP.negate()}aP.applyMatrix3(o).normalize()}l.vertexNormalsLength=X.length;var ah=aw[aK];if(ah!==undefined){for(var aC=0;aC<3;aC++){l.uvs[aC].copy(ah[aC])}}l.color=Z.color;l.material=aI;l.z=(aQ.positionScreen.z+aO.positionScreen.z+aM.positionScreen.z)/3;H.elements.push(l)}}}}else{if(aA instanceof THREE.Line){if(ac instanceof THREE.BufferGeometry){var ay=ac.attributes;if(ay.position!==undefined){var aa=ay.position.array;for(var aJ=0,aH=aa.length;aJ<aH;aJ+=3){D.pushVertex(aa[aJ],aa[aJ+1],aa[aJ+2])}if(ay.index!==undefined){var V=ay.index.array;for(var aJ=0,aH=V.length;aJ<aH;aJ+=2){D.pushLine(V[aJ],V[aJ+1])}}else{var at=aA.mode===THREE.LinePieces?2:1;for(var aJ=0,aH=(aa.length/3)-1;aJ<aH;aJ+=at){D.pushLine(aJ,aJ+1)}}}}else{if(ac instanceof THREE.Geometry){B.multiplyMatrices(g,z);var U=aA.geometry.vertices;if(U.length===0){continue}aQ=u();aQ.positionScreen.copy(U[0]).applyMatrix4(B);var at=aA.mode===THREE.LinePieces?2:1;for(var aB=1,af=U.length;aB<af;aB++){aQ=u();aQ.positionScreen.copy(U[aB]).applyMatrix4(B);if((aB+1)%at>0){continue}aO=f[c-2];s.copy(aQ.positionScreen);h.copy(aO.positionScreen);if(w(s,h)===true){s.multiplyScalar(1/s.w);h.multiplyScalar(1/h.w);i=E();i.id=aA.id;i.v1.positionScreen.copy(s);i.v2.positionScreen.copy(h);i.z=Math.max(s.z,h.z);i.material=aA.material;if(aA.material.vertexColors===THREE.VertexColors){i.vertexColors[0].copy(aA.geometry.colors[aB]);i.vertexColors[1].copy(aA.geometry.colors[aB-1])}H.elements.push(i)}}}}}else{if(aA instanceof THREE.Sprite){G.set(z.elements[12],z.elements[13],z.elements[14],1);G.applyMatrix4(g);var aL=1/G.w;G.z*=aL;if(G.z>=-1&&G.z<=1){y=j();y.id=aA.id;y.x=G.x*aL;y.y=G.y*aL;y.z=G.z;y.object=aA;y.rotation=aA.rotation;y.scale.x=aA.scale.x*Math.abs(y.x-(G.x+ag.projectionMatrix.elements[0])/(G.w+ag.projectionMatrix.elements[12]));y.scale.y=aA.scale.y*Math.abs(y.y-(G.y+ag.projectionMatrix.elements[5])/(G.w+ag.projectionMatrix.elements[13]));y.material=aA.material;H.elements.push(y)}}}}}if(W===true){H.elements.sort(p)}return H};function m(){if(C===n){var S=new THREE.RenderableObject();J.push(S);n++;C++;return S}return J[C++]}function u(){if(c===b){var S=new THREE.RenderableVertex();f.push(S);b++;c++;return S}return f[c++]}function k(){if(A===x){var S=new THREE.RenderableFace();F.push(S);x++;A++;return S}return F[A++]}function E(){if(M===t){var S=new THREE.RenderableLine();O.push(S);t++;M++;return S}return O[M++]}function j(){if(q===P){var S=new THREE.RenderableSprite();e.push(S);P++;q++;return S}return e[q++]}function p(T,S){if(T.z!==S.z){return S.z-T.z}else{if(T.id!==S.id){return T.id-S.id}else{return 0}}}function w(W,V){var U=0,Z=1,X=W.z+W.w,T=V.z+V.w,S=-W.z+W.w,Y=-V.z+V.w;if(X>=0&&T>=0&&S>=0&&Y>=0){return true}else{if((X<0&&T<0)||(S<0&&Y<0)){return false}else{if(X<0){U=Math.max(U,X/(X-T))}else{if(T<0){Z=Math.min(Z,X/(X-T))}}if(S<0){U=Math.max(U,S/(S-Y))}else{if(Y<0){Z=Math.min(Z,S/(S-Y))}}if(Z<U){return false}else{W.lerp(V,U);V.lerp(W,1-Z);return true}}}}};